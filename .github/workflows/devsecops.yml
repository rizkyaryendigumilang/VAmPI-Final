name: DevSecOps-Ultimate-Pipeline

on:
  push:
    branches: [ "main", "master" ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. RUN MASTER SCAN SCRIPT (SAST, SCA, IaC) ---
      - name: Run Static Security Scans
        run: |
          chmod +x scan_otomatis.sh
          ./scan_otomatis.sh > hasil_scan_lengkap.txt 2>&1 || true

      # --- 2. PREPARE APP FOR DAST ---
      - name: Build and Run VAmPI
        run: |
          docker build -t vampi-app .
          docker run -d --name vampi-instance -p 5000:5000 vampi-app
          sleep 20 # Memberikan waktu aplikasi untuk benar-benar siap

      # --- 3. DAST: OWASP ZAP (DYNAMIC PENTESTING) ---
      - name: Run OWASP ZAP Pentest
        run: |
          docker run --rm --network="host" -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://localhost:5000 \
            -r zap-report.html > zap-log.txt || true

      # --- 4. SEND COMPLETE REPORTS VIA EMAIL ---
      - name: Send Multi-Layer Security Reports
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸ›¡ï¸ DevSecOps Scanning: ${{ github.repository }} [SUCCESS]"
          to: rizkyaryendigumilang@gmail.com
          from: DevSecOps Automation Bot
          body: |
            Halo Rizky,

            Pipeline Keamanan Otomatis telah selesai dijalankan. 
            Berikut adalah hasil Scanning keamanan berlapis (Layered Security):

            1. IaC Scan (Hadolint) -> Infrastructure Check
            2. SCA Scan (Trivy) -> Dependency Check
            3. SAST Scan (Semgrep) -> Source Code Check
            4. DAST Scan (OWASP ZAP) -> Runtime Pentesting

            Detail temuan dapat dilihat pada lampiran laporan di bawah ini.
            
            Status: ${{ job.status }}
          attachments: hasil_scan_lengkap.txt,hadolint-report.txt,trivy-report.txt,semgrep-report.txt,zap-log.txt
